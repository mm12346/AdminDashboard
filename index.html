<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตรวจสอบข้อมูลหลายชีต</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Web App Manifest for PWA capabilities -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Multi-Sheet Checker">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <meta name="theme-color" content="#3B82F6"> <!-- Matches blue-500 from Tailwind -->

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        .loader {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            border: 3px solid;
            border-color: #CBD5E1 #CBD5E1 transparent transparent; /* slate-300 */
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .loader::after {
            content: '';  
            box-sizing: border-box;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
            border: 3px solid;
            border-color: transparent transparent #3B82F6 #3B82F6; /* blue-500 */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            animation: rotationBack 0.5s linear infinite;
            transform-origin: center center;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        } 
        @keyframes rotationBack {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(-360deg); }
        }
        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* shadow-xl */
            width: 100%;
            max-width: 600px;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6 bg-slate-50">

    <div class="mb-6 flex space-x-4 items-center">
        <!-- Global Date Input -->
        <div class="flex-grow">
            <label for="globalCheckDate" class="sr-only">เลือกวันที่</label>
            <input type="date" id="globalCheckDate" class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition placeholder:text-slate-400 text-base">
        </div>
        
        <button id="refreshButton" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-xl shadow-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-all duration-300 flex items-center space-x-2">
            <!-- New Refresh Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 019-9 9.75 9.75 0 016.74 2.74L21 8" />
                <path d="M21 3v5h-5" />
                <path d="M21 12a9 9 0 01-9 9 9.75 9.75 0 01-6.74-2.74L3 16" />
                <path d="M3 21v-5h5" />
            </svg>
            <span>รีเฟรช</span>
        </button>

        <button id="settingsButton" class="px-6 py-3 bg-slate-600 text-white font-semibold rounded-xl shadow-lg hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-opacity-75 transition-all duration-300 flex items-center space-x-2">
            <!-- New Settings Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12.22 2h-.44a2 2 0 00-2 2v.18a2 2 0 01-1 1.73l-.43.25a2 2 0 01-2 0l-.15-.08a2 2 0 00-2.73.73l-.78 1.25a2 2 0 00.73 2.73l.04.04a2 2 0 010 2.83l-.04.04a2 2 0 00-.73 2.73l.78 1.25a2 2 0 002.73.73l.15-.08a2 2 0 012 0l.43.25a2 2 0 011 1.73V20a2 2 0 002 2h.44a2 2 0 002-2v-.18a2 2 0 011-1.73l.43-.25a2 2 0 012 0l.15.08a2 2 0 002.73-.73l.78-1.25a2 2 0 00-.73-2.73l-.04-.04a2 2 0 010-2.83l.04-.04a2 2 0 00.73-2.73l-.78-1.25a2 2 0 00-2.73-.73l-.15.08a2 2 0 01-2 0l-.43-.25a2 2 0 01-1-1.73V4a2 2 0 00-2-2z" />
                <circle cx="12" cy="12" r="3" />
            </svg>
            <span>ตั้งค่า</span>
        </button>
    </div>

    <div id="app-container" class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Cards will be dynamically inserted here -->
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeSettingsModal">&times;</span>
            <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">ตั้งค่าการ์ด</h2>

            <div class="mb-4">
                <label for="cardSelect" class="block text-sm font-medium text-slate-600 mb-1">เลือกการ์ด:</label>
                <select id="cardSelect" class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-base">
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <div class="space-y-4 mb-6">
                <div>
                    <label for="titleInput" class="block text-sm font-medium text-slate-600 mb-1">ชื่อการ์ด (Title):</label>
                    <input type="text" id="titleInput" class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-base">
                </div>
                <div>
                    <label for="sheetIdInput" class="block text-sm font-medium text-slate-600 mb-1">รหัสชีต (Sheet ID):</label>
                    <input type="text" id="sheetIdInput" class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-base">
                </div>
                <div>
                    <label for="sheetNameInput" class="block text-sm font-medium text-slate-600 mb-1">ชื่อชีต (Sheet Name):</label>
                    <input type="text" id="sheetNameInput" class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-base">
                </div>
                <div>
                    <label for="targetCountInput" class="block text-sm font-medium text-slate-600 mb-1">จำนวนเป้าหมาย (Target Count):</label>
                    <input type="number" id="targetCountInput" class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-base">
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3">
                <button id="addCardBtn" class="px-5 py-2 bg-green-500 text-white font-semibold rounded-xl shadow hover:bg-green-600 transition">เพิ่มการ์ดใหม่</button>
                <button id="deleteCardBtn" class="px-5 py-2 bg-red-500 text-white font-semibold rounded-xl shadow hover:bg-red-600 transition">ลบการ์ดที่เลือก</button>
                <button id="saveSettingsBtn" class="px-5 py-2 bg-blue-500 text-white font-semibold rounded-xl shadow hover:bg-blue-600 transition">บันทึกการเปลี่ยนแปลง</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmationModal" class="modal">
        <div class="modal-content max-w-sm text-center p-8">
            <h3 class="text-xl font-bold text-slate-800 mb-4">ยืนยันการลบ</h3>
            <p class="text-slate-600 mb-6">คุณแน่ใจหรือไม่ว่าต้องการลบการ์ดนี้?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteBtn" class="px-6 py-2 bg-red-500 text-white font-semibold rounded-lg shadow hover:bg-red-600 transition">ใช่, ลบเลย</button>
                <button id="cancelDeleteBtn" class="px-6 py-2 bg-slate-300 text-slate-800 font-semibold rounded-lg shadow hover:bg-slate-400 transition">ไม่, ยกเลิก</button>
            </div>
        </div>
    </div>

    <script>
        // Base URL for the Google Apps Script deployment
        const SCRIPT_URL_BASE = 'https://script.google.com/macros/s/AKfycbxDwbVoLfFR7uXoWDgPv6Jb-xSXY83GBznZpu9U0Gw0J0CGkQs_iMTbmP5--dc0WLc6/exec';

        // Default configurations for each card/sheet
        // These will be used if no settings are found in localStorage
        // The array is now empty to start with no pre-filled data.
        let cardConfigurations = [];

        // DOM Elements
        const appContainer = document.getElementById('app-container');
        const refreshButton = document.getElementById('refreshButton');
        const settingsButton = document.getElementById('settingsButton');
        const globalCheckDateInput = document.getElementById('globalCheckDate'); // New global date input
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModal');
        const cardSelect = document.getElementById('cardSelect');
        const titleInput = document.getElementById('titleInput');
        const sheetIdInput = document.getElementById('sheetIdInput');
        const sheetNameInput = document.getElementById('sheetNameInput');
        const targetCountInput = document.getElementById('targetCountInput');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const addCardBtn = document.getElementById('addCardBtn');
        const deleteCardBtn = document.getElementById('deleteCardBtn');

        // Delete Confirmation Modal elements
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');


        let selectedCardIndex = 0; // To keep track of which card is being edited

        // --- Local Storage Functions ---
        function loadConfigurations() {
            const storedConfig = localStorage.getItem('cardConfigurations');
            if (storedConfig) {
                try {
                    cardConfigurations = JSON.parse(storedConfig);
                } catch (e) {
                    console.error("Error parsing stored configurations, using default (empty array).", e);
                    // Fallback to empty array if parsing fails
                    cardConfigurations = [];
                }
            }
        }

        function saveConfigurations() {
            localStorage.setItem('cardConfigurations', JSON.stringify(cardConfigurations));
            console.log("Configurations saved to localStorage.");
        }

        // --- Card Rendering Functions ---
        function createCard(config, index) {
            const cardId = `card-${index}`;
            const resultsDivId = `results-${index}`; // No more individual date input ID

            const cardHtml = `
                <div id="${cardId}" class="bg-white/90 backdrop-blur-sm border border-slate-200 rounded-2xl shadow-xl shadow-slate-300/30 p-6 md:p-8 space-y-6">
                    <div class="text-center">
                        <h1 class="text-xl sm:text-2xl font-bold text-slate-800">${config.title}</h1>
                        <p class="text-slate-500 mt-2 text-sm sm:text-base">ข้อมูลสำหรับวันที่เลือก</p>
                    </div>

                    <!-- Results Section -->
                    <div id="${resultsDivId}" class="mt-6 p-5 bg-slate-50/70 rounded-xl min-h-[150px] flex items-center justify-center transition-all">
                        <p class="text-slate-500">กำลังโหลดข้อมูล...</p>
                    </div>
                </div>
            `;
            appContainer.insertAdjacentHTML('beforeend', cardHtml);

            // Get DOM element for the newly created card's results div
            const resultsDiv = document.getElementById(resultsDivId);

            // Initial data load for this card using the global date
            checkSheetData(config, globalCheckDateInput.value, resultsDiv);
        }

        function renderApp() {
            appContainer.innerHTML = ''; // Clear existing cards before re-rendering
            if (cardConfigurations.length === 0) {
                appContainer.innerHTML = '<p class="text-slate-500 text-center col-span-full">ไม่พบการ์ด กรุณาเพิ่มการ์ดใหม่ในการตั้งค่า</p>';
                return;
            }
            // Use the value from the global date input for all cards
            const currentGlobalDate = globalCheckDateInput.value;
            cardConfigurations.forEach((config, index) => {
                createCard(config, index);
                // Call checkSheetData again for each card with the current global date
                // This ensures all cards update when the global date changes
                checkSheetData(config, currentGlobalDate, document.getElementById(`results-${index}`));
            });
        }

        // --- Data Fetching Functions (Modified to use globalDateValue) ---
        async function checkSheetData(config, dateValue, resultsEl) { // Changed dateInputEl to dateValue
            
            if (config.sheetId === 'YOUR_SHEET_ID_HERE' || config.sheetId.startsWith('YOUR_SHEET_ID_')) {
                renderError(resultsEl, `กรุณาตั้งค่า SHEET_ID ของ '${config.title}' ในโค้ด HTML ก่อน`);
                return;
            }
             if (!dateValue) { // Check dateValue directly
                resultsEl.innerHTML = '<p class="text-slate-500">กรุณาเลือกวันที่</p>';
                return;
            }

            resultsEl.innerHTML = '<div class="loader"></div>'; // Show loader

            const selectedDate = new Date(dateValue); // Use dateValue directly

            let finalUrl = `${SCRIPT_URL_BASE}?sheetId=${encodeURIComponent(config.sheetId)}`;
            if (config.sheetName) {
                finalUrl += `&sheetName=${encodeURIComponent(config.sheetName)}`;
            }

            try {
                const response = await fetch(finalUrl);
                if (!response.ok) throw new Error('Network response was not ok. Status: ' + response.status);
                
                const allRows = await response.json();
                if (allRows.error) throw new Error('Apps Script Error: ' + allRows.error);

                const foundEntries = [];
                // Column indices (adjust if your sheet structure changes for different sheets)
                // COL_DAY, COL_MONTH, COL_YEAR, COL_USER, COL_NUMBER
                // These are generic, you might need to make them configurable per sheet if layouts vary greatly
                const COL_DAY = 1, COL_MONTH = 2, COL_YEAR = 3, COL_USER = 7, COL_NUMBER = 9; 
                
                for (const columns of allRows) {
                    if (columns.length > Math.max(COL_YEAR, COL_USER, COL_NUMBER)) {
                        const day = parseInt(columns[COL_DAY], 10);
                        const month = parseInt(columns[COL_MONTH], 10);
                        let year = parseInt(columns[COL_YEAR], 10);

                        if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                            // Convert Buddhist year to Gregorian year if applicable
                            if (year > 2500) year -= 543;
                            const rowDate = new Date(year, month - 1, day);
                            
                            if (!isNaN(rowDate.getTime()) && rowDate.getFullYear() === selectedDate.getFullYear() && rowDate.getMonth() === selectedDate.getMonth() && rowDate.getDate() === selectedDate.getDate()) {
                                foundEntries.push({
                                    user: columns[COL_USER] ? String(columns[COL_USER]).trim() : 'ไม่มีข้อมูล',
                                    number: columns[COL_NUMBER] ? String(columns[COL_NUMBER]).trim() : 'ไม่มีข้อมูล'
                                });
                            }
                        }
                    }
                }
                renderResults(resultsEl, foundEntries, selectedDate.toLocaleDateString('th-TH', { dateStyle: 'long' }), config.targetCount);
            } catch (error) {
                console.error(`Error fetching or parsing data for ${config.title}:`, error);
                renderError(resultsEl, `เกิดข้อผิดพลาดในการดึงข้อมูลสำหรับ '${config.title}'<br>โปรดตรวจสอบว่า Sheet ID, Sheet Name ที่ตั้งค่าไว้ถูกต้อง`);
            }
        }

        function renderResults(resultsEl, entries, date, targetCount) {
            resultsEl.innerHTML = '';
            const uniqueNumbers = new Set(entries.map(entry => entry.number).filter(num => num && num !== 'ไม่มีข้อมูล'));
            const uniqueUsers = new Set(entries.map(entry => entry.user).filter(user => user && user !== 'ไม่มีข้อมูล'));
            
            let statusBlock, detailsBlock;

            if (entries.length === 0) {
                 statusBlock = `
                    <div class="flex flex-col items-center justify-center text-center text-slate-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mb-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        <p class="font-semibold text-slate-700">ไม่พบข้อมูลสำหรับวันที่ ${date}</p>
                        <p class="text-sm">กรุณาตรวจเช็คออนไลน์ก่อน แล้วตรวจสอบอีกครั้ง</p>
                    </div>`;
                resultsEl.innerHTML = statusBlock;
                return;
            }
            
            if (uniqueNumbers.size >= targetCount) {
                statusBlock = `
                    <div class="bg-teal-50 border border-teal-200 text-teal-800 p-4 rounded-xl flex items-center space-x-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        <div>
                            <p class="font-bold text-lg">ครบแล้ว</p>
                            <p class="text-sm">ตรวจครบ ${targetCount} หมายเลขสำหรับวันที่ ${date}</p>
                        </div>
                    </div>`;
            } else {
                const needed = targetCount - uniqueNumbers.size;
                statusBlock = `
                    <div class="bg-amber-50 border border-amber-200 text-amber-800 p-4 rounded-xl flex items-center space-x-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 5a1 1 0 011 1v3a1 1 0 11-2 0V6a1 1 0 011-1zm1 5a1 1 0 10-2 0v2a1 1 0 102 0v-2z" clip-rule="evenodd" /></svg>
                        <div>
                             <p class="font-bold text-lg">ยังไม่ครบ (${uniqueNumbers.size}/${targetCount})</p>
                             <p class="text-sm">ข้อมูลสำหรับวันที่ ${date} ขาดอีก ${needed} หมายเลข</p>
                        </div>
                    </div>`;
            }
            
            detailsBlock = `
                <div class="space-y-4 pt-4 text-sm">
                    <div class="flex items-start space-x-3">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0 text-slate-400 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        <div>
                            <p class="font-semibold text-slate-600">ผู้ลงข้อมูล:</p>
                            <p class="text-slate-800">${uniqueUsers.size > 0 ? [...uniqueUsers].join(', ') : 'ไม่พบข้อมูล'}</p>
                        </div>
                    </div>
                     <div class="flex items-start space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0 text-slate-400 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                        <div>
                            <p class="font-semibold text-slate-600">หมายเลขที่ตรวจแล้ว (${uniqueNumbers.size} หมายเลข):</p>
                            <p class="text-slate-800">${uniqueNumbers.size > 0 ? [...uniqueNumbers].join(', ') : 'ไม่พบหมายเลข'}</p>
                        </div>
                    </div>
                </div>
            `;
            
            resultsEl.innerHTML = `<div class="w-full">${statusBlock}${detailsBlock}</div>`;
        }

        function renderError(resultsEl, message) {
            resultsEl.innerHTML = `
            <div class="bg-rose-50 border border-rose-200 text-rose-800 p-4 rounded-xl flex flex-col items-center justify-center text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                <p class="font-bold">เกิดข้อผิดพลาด</p>
                <p class="text-sm">${message}</p>
            </div>`;
        }

        // --- Settings Modal Functions ---
        function openSettingsModal() {
            settingsModal.style.display = 'flex'; // Use flex to center content
            populateCardSelect();
            updateSettingsInputs();
        }

        function closeSettingsModal() {
            settingsModal.style.display = 'none';
        }

        function populateCardSelect() {
            cardSelect.innerHTML = ''; // Clear existing options
            if (cardConfigurations.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'ไม่มีการ์ดให้เลือก';
                option.disabled = true;
                option.selected = true;
                cardSelect.appendChild(option);
            } else {
                cardConfigurations.forEach((config, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = config.title;
                    cardSelect.appendChild(option);
                });
                // Select the current card if it exists
                if (selectedCardIndex >= 0 && selectedCardIndex < cardConfigurations.length) {
                    cardSelect.value = selectedCardIndex;
                } else {
                    selectedCardIndex = 0; // Default to first card if current index is invalid
                    cardSelect.value = selectedCardIndex;
                }
            }
        }

        function updateSettingsInputs() {
            if (cardConfigurations.length > 0 && selectedCardIndex >= 0 && selectedCardIndex < cardConfigurations.length) {
                const config = cardConfigurations[selectedCardIndex];
                titleInput.value = config.title || '';
                sheetIdInput.value = config.sheetId || '';
                sheetNameInput.value = config.sheetName || '';
                targetCountInput.value = config.targetCount || '';
                deleteCardBtn.disabled = false; // Enable delete button if there's a card
                titleInput.disabled = false;
                sheetIdInput.disabled = false;
                sheetNameInput.disabled = false;
                targetCountInput.disabled = false;
                saveSettingsBtn.disabled = false;
            } else {
                // No card selected or no cards exist, clear and disable inputs
                titleInput.value = '';
                sheetIdInput.value = '';
                sheetNameInput.value = '';
                targetCountInput.value = '';
                deleteCardBtn.disabled = true; // Disable delete button
                titleInput.disabled = true;
                sheetIdInput.disabled = true;
                sheetNameInput.disabled = true;
                targetCountInput.disabled = true;
                saveSettingsBtn.disabled = true;
            }
        }

        function handleCardSelectChange() {
            selectedCardIndex = parseInt(cardSelect.value, 10);
            updateSettingsInputs();
        }

        function handleSaveSettings() {
            if (cardConfigurations.length === 0 || titleInput.disabled) {
                // Should not happen if inputs are disabled, but as a safeguard
                return; 
            }

            const currentConfig = cardConfigurations[selectedCardIndex];
            currentConfig.title = titleInput.value.trim();
            currentConfig.sheetId = sheetIdInput.value.trim();
            currentConfig.sheetName = sheetNameInput.value.trim();
            currentConfig.targetCount = parseInt(targetCountInput.value, 10);

            if (isNaN(currentConfig.targetCount) || currentConfig.targetCount < 0) {
                currentConfig.targetCount = 0; // Default or error handling for targetCount
            }

            saveConfigurations();
            renderApp(); // Re-render all cards with updated settings
            populateCardSelect(); // Refresh dropdown in case titles changed
            closeSettingsModal();
        }

        function handleAddCard() {
            const newCard = {
                title: `การ์ดใหม่ ${cardConfigurations.length + 1}`,
                sheetId: 'YOUR_SHEET_ID_HERE',
                sheetName: 'Sheet1',
                targetCount: 1
            };
            cardConfigurations.push(newCard);
            selectedCardIndex = cardConfigurations.length - 1; // Select the newly added card
            saveConfigurations();
            renderApp();
            populateCardSelect(); // Update dropdown with new card
            updateSettingsInputs(); // Show new card's details in inputs
        }

        function handleDeleteCard() {
            if (cardConfigurations.length > 0) {
                showDeleteConfirmation();
            }
        }

        function showDeleteConfirmation() {
            deleteConfirmationModal.style.display = 'flex';
        }

        function hideDeleteConfirmation() {
            deleteConfirmationModal.style.display = 'none';
        }

        function confirmDeletionAction() {
            cardConfigurations.splice(selectedCardIndex, 1);
            // Adjust selected index if the last card was deleted, or set to 0
            if (selectedCardIndex >= cardConfigurations.length && cardConfigurations.length > 0) {
                selectedCardIndex = cardConfigurations.length - 1;
            } else if (cardConfigurations.length === 0) {
                selectedCardIndex = 0; // No cards left
            }
            saveConfigurations();
            renderApp();
            populateCardSelect(); // Update dropdown after deletion
            updateSettingsInputs(); // Clear or show new selected card's details
            hideDeleteConfirmation(); // Close the confirmation modal
        }


        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date to today for the global input
            const today = new Date();
            globalCheckDateInput.value = today.toISOString().split('T')[0];

            loadConfigurations(); // Load settings from localStorage first
            renderApp(); // Render all cards based on loaded configurations

            // Attach event listener for global date input change
            globalCheckDateInput.addEventListener('change', renderApp);

            // Attach settings button listeners
            settingsButton.addEventListener('click', openSettingsModal);
            closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
            cardSelect.addEventListener('change', handleCardSelectChange);
            saveSettingsBtn.addEventListener('click', handleSaveSettings);
            addCardBtn.addEventListener('click', handleAddCard);
            deleteCardBtn.addEventListener('click', handleDeleteCard);
            
            // Attach delete confirmation modal listeners
            confirmDeleteBtn.addEventListener('click', confirmDeletionAction);
            cancelDeleteBtn.addEventListener('click', hideDeleteConfirmation);

            // Add event listener to the refresh button
            refreshButton.addEventListener('click', renderApp);


            // Register Service Worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('Service Worker registered:', registration);
                        })
                        .catch(error => {
                            console.error('Service Worker registration failed:', error);
                        });
                });
            }
        });
    </script>
</body>
</html>
